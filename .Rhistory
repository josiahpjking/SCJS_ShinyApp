div(class="plot-below",
tags$p("Hover over the cursor over a point to see more information."),
checkboxInput("erbar",label = "Show Confidence Intervals",value=TRUE),
checkboxInput("showleg1",label = "Show Legend",value=TRUE),
actionButton("reset_trends","Reset plot")
)
)
)
?source
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
fluidPage(
#get CSS style stuff.
includeCSS("./www/stuff.css"),
#main body of app. It's a navbar, so menu at top, different tabs.
#each tab is sourced from a separate file to help the layout be a little easier to get to grips with.
navbarPage(title="",
id="main",
position="fixed-top",
collapsible=TRUE,
header = div(class="header-back",
tags$h1(class="head-control",
a(target="_blank",href="http://www.gov.scot/Topics/Statistics/Browse/Crime-Justice/crime-and-justice-survey","Scottish Crime & Justice Survey"),
tags$img(src="scotgov.png",width=200,align="left")
)),
#########
#HOME
#########
tabPanel("Home",icon = icon('home',lib="glyphicon"),
source("source/ui_home.R")
),
##########
#Division Breakdowns (main_divisions)
##########
tabPanel("Breakdown by Police Divisions", value="main_divisions",
source("source/ui_overview.R", verbose=F)
),
##########
#COMPARISON TOOL (main_compare)
##########
tabPanel("Comparison Tool", value="main_compare", icon = icon('bar-chart'),
source("source/ui_comparison.R")
),
##########
#TRENDS OVER TIME (main_trends)
##########
tabPanel("Visualise Trends", value="main_trends", icon = icon('line-chart'),
source("source/ui_trends.R",local=T,echo=T)
),
##########
#TABLES (main_tables)
##########
tabPanel("Tables", value="main_tables", icon = icon('download-alt', lib='glyphicon'),
source("source/ui_tables.R")
),
##########
#HELP & INFO (main_help)
##########
tabPanel("Help & Information", value="main_help", icon=icon('info-sign',lib="glyphicon"),
source("source/ui_help.R")
)
)
)
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
fluidPage(
#get CSS style stuff.
includeCSS("./www/stuff.css"),
#main body of app. It's a navbar, so menu at top, different tabs.
#each tab is sourced from a separate file to help the layout be a little easier to get to grips with.
navbarPage(title="",
id="main",
position="fixed-top",
collapsible=TRUE,
header = div(class="header-back",
tags$h1(class="head-control",
a(target="_blank",href="http://www.gov.scot/Topics/Statistics/Browse/Crime-Justice/crime-and-justice-survey","Scottish Crime & Justice Survey"),
tags$img(src="scotgov.png",width=200,align="left")
)),
#########
#HOME
#########
tabPanel("Home",icon = icon('home',lib="glyphicon"),
source("source/ui_home.R")
),
##########
#Division Breakdowns (main_divisions)
##########
tabPanel("Breakdown by Police Divisions", value="main_divisions",
source("source/ui_overview.R", verbose=F)
),
##########
#COMPARISON TOOL (main_compare)
##########
tabPanel("Comparison Tool", value="main_compare", icon = icon('bar-chart'),
source("source/ui_comparison.R")
),
##########
#TRENDS OVER TIME (main_trends)
##########
tabPanel("Visualise Trends", value="main_trends", icon = icon('line-chart'),
source("source/ui_trends.R",verbose=T)
),
##########
#TABLES (main_tables)
##########
tabPanel("Tables", value="main_tables", icon = icon('download-alt', lib='glyphicon'),
source("source/ui_tables.R")
),
##########
#HELP & INFO (main_help)
##########
tabPanel("Help & Information", value="main_help", icon=icon('info-sign',lib="glyphicon"),
source("source/ui_help.R")
)
)
)
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
#packages needed
require(tidyr)
require(dplyr)
require(ggplot2)
require(magrittr)
require(plotly)
df<-readRDS("data/pdiv9.6.test.rds")
#police division colours
pdivcols=c("Argyll & West Dunbartonshire (L Division)"='#66C2A5',
"Ayrshire (U Division)"='#FC8D62',
"Dumfries & Galloway (V Division)"='#8DA0CB',
"Edinburgh City (E Division)"='#E78AC3',
"Fife (P Division)"='#A6D854',
"Forth Valley (C Division)"='#FFD92F',
"Greater Glasgow (G Division)"='#E5C494',
"Highlands & Islands (N Division)"='#8DD3C7',
"Lanarkshire (Q Division)"='#FB8072',
"Lothians & Scottish Borders (J Division)"='#BEBADA',
"NA"='#FFFFB3',
"North East (A Division)"='#80B1D3',
"Renfrewshire & Inverclyde (K Division)"='#FDB462',
"Tayside (D Division)"='#B3DE69',
"National Average"='#000000')
#colours for overview page (national avg = black, and better/worse/none is included)
overview_cols=c(pdivcols,
"No difference"="#BDBDBD",
"More Positive"="#95fb71",
"Less Positive"="#fb7171")
#modebar icons to remove (these are the little buttons on the plots.)
modebar_remove <- c('hoverClosestCartesian','hoverCompareCartesian','zoom2d','pan2d','toggleSpikelines','select2d','lasso2d','zoomIn2d','zoomOut2d')
#app-user inputs. (these are the choices users will get to select from)
des_factor <- df %>% group_by(year) %>% summarise(des_f=first(des_factor)) #design factors
pdivis<-levels(factor(df$police_div)) #police divisions
years=levels(df$year) #years
currentyear=years[length(years)] #latest survey year
prevyear=years[length(years)-1] #previous survey year
firstyear=years[1] #first survey year
yn<-c("Yes","No") #yes no choices
getnames<-function(string){
df %>%
filter(grepl(string,variable)) %>%
pull(name_trunc) %>%
unique() %>%
as.character()
}
#variables/variable groupings
all_vars<-list('National Indicators'= getnames("PREVSURVEY|QS2AREA:|DCONF_03"),
'Rates of Crime Victimisation'=getnames("PREV"),
'Confidence in the Police'=getnames("POLCONF|RATPOL"),
'Attitudes to the Police'=getnames("POLOP|POLPRES"),
'Confidence in Scottish Criminal Justice System'=getnames("DCONF"),
'Perceptions of Crime Rates and Safety'=getnames("QS"),
'Perceptions of Local Crime'=getnames("QACO"),
'Perceptions of Local People'=getnames("LCPEOP"),
'Worries of Crime Victimisation'=getnames("QWORR"),
'Worries of Being Harassed'=getnames("HWORR")
)
######## map data ##########
pd_latlon <- readRDS("data/pd_mapdata.RDS")
######## national indicator data #########
df %>% filter(police_div=="National Average",
year %in% c(currentyear,prevyear),
variable %in% all_vars[[1]]) %>%
group_by(variable) %>%
summarise(
current_percentage = percentage[which(year==currentyear)],
current_ci = ci[which(year==currentyear)],
p_diff=abs(diff(p)),
c=sqrt(sum(ci^2)),
p_signif=p_diff>c,
rev_coded=first(reverse_coded),
thisyear = ifelse(p_signif==TRUE & year[which(p==min(p))]==currentyear, "lower",
ifelse(p_signif==TRUE & year[which(p==min(p))]!=currentyear, "higher",
"same")),
thisyear_imp = ifelse(rev_coded==1 & thisyear=="higher","lower",
ifelse(rev_coded==1 & thisyear=="lower","higher", thisyear)),
thisyear_col = ifelse(thisyear_imp=="higher","#95fb71",
ifelse(thisyear_imp=="lower","#fb7171","#BDBDBD"))
) %>% select(variable, current_percentage, current_ci, thisyear_imp, thisyear_col) -> image_data
image_data %>% filter(grepl("Confident",variable)) -> ni_conf_data
image_data %>% filter(grepl("Victim",variable)) -> ni_crime_data
image_data %>% filter(grepl("Perceived",variable)) -> ni_perc_data
############ save Rdata to the app directory ############
#now overwrite variable with more user-friendly input
df$variable<-df$name_trunc
ungroup(df) -> df
#update the app data.
save.image(file = "./app/.RData")
df<-readRDS("data/pdiv9.6.test.rds")
#police division colours
pdivcols=c("Argyll & West Dunbartonshire (L Division)"='#66C2A5',
"Ayrshire (U Division)"='#FC8D62',
"Dumfries & Galloway (V Division)"='#8DA0CB',
"Edinburgh City (E Division)"='#E78AC3',
"Fife (P Division)"='#A6D854',
"Forth Valley (C Division)"='#FFD92F',
"Greater Glasgow (G Division)"='#E5C494',
"Highlands & Islands (N Division)"='#8DD3C7',
"Lanarkshire (Q Division)"='#FB8072',
"Lothians & Scottish Borders (J Division)"='#BEBADA',
"NA"='#FFFFB3',
"North East (A Division)"='#80B1D3',
"Renfrewshire & Inverclyde (K Division)"='#FDB462',
"Tayside (D Division)"='#B3DE69',
"National Average"='#000000')
df<-readRDS("data/pdiv9.6.test.rds")
#police division colours
pdivcols=c("Argyll & West Dunbartonshire (L Division)"='#66C2A5',
"Ayrshire (U Division)"='#FC8D62',
"Dumfries & Galloway (V Division)"='#8DA0CB',
"Edinburgh City (E Division)"='#E78AC3',
"Fife (P Division)"='#A6D854',
"Forth Valley (C Division)"='#FFD92F',
"Greater Glasgow (G Division)"='#E5C494',
"Highlands & Islands (N Division)"='#8DD3C7',
"Lanarkshire (Q Division)"='#FB8072',
"Lothians & Scottish Borders (J Division)"='#BEBADA',
"NA"='#FFFFB3',
"North East (A Division)"='#80B1D3',
"Renfrewshire & Inverclyde (K Division)"='#FDB462',
"Tayside (D Division)"='#B3DE69',
"National Average"='#000000')
#colours for overview page (national avg = black, and better/worse/none is included)
overview_cols=c(pdivcols,
"No difference"="#BDBDBD",
"More Positive"="#95fb71",
"Less Positive"="#fb7171")
#modebar icons to remove (these are the little buttons on the plots.)
modebar_remove <- c('hoverClosestCartesian','hoverCompareCartesian','zoom2d','pan2d','toggleSpikelines','select2d','lasso2d','zoomIn2d','zoomOut2d')
des_factor <- df %>% group_by(year) %>% summarise(des_f=first(des_factor)) #design factors
des_factor <- df %>% group_by(year) %>% summarise(des_f=first(des_fact)) #design factors
pdivis<-levels(factor(df$police_div)) #police divisions
years=levels(df$year) #years
currentyear=years[length(years)] #latest survey year
prevyear=years[length(years)-1] #previous survey year
firstyear=years[1] #first survey year
yn<-c("Yes","No") #yes no choices
getnames<-function(string){
df %>%
filter(grepl(string,variable)) %>%
pull(name_trunc) %>%
unique() %>%
as.character()
}
#variables/variable groupings
all_vars<-list('National Indicators'= getnames("PREVSURVEY|QS2AREA:|DCONF_03"),
'Rates of Crime Victimisation'=getnames("PREV"),
'Confidence in the Police'=getnames("POLCONF|RATPOL"),
'Attitudes to the Police'=getnames("POLOP|POLPRES"),
'Confidence in Scottish Criminal Justice System'=getnames("DCONF"),
'Perceptions of Crime Rates and Safety'=getnames("QS"),
'Perceptions of Local Crime'=getnames("QACO"),
'Perceptions of Local People'=getnames("LCPEOP"),
'Worries of Crime Victimisation'=getnames("QWORR"),
'Worries of Being Harassed'=getnames("HWORR")
)
######## map data ##########
pd_latlon <- readRDS("data/pd_mapdata.RDS")
df %>% filter(police_div=="National Average",
year %in% c(currentyear,prevyear),
variable %in% all_vars[[1]])
all_vars[[1]]
#now overwrite variable with more user-friendly input
df$variable<-df$name_trunc
######## national indicator data #########
df %>% filter(police_div=="National Average",
year %in% c(currentyear,prevyear),
variable %in% all_vars[[1]]) %>%
group_by(variable) %>%
summarise(
current_percentage = percentage[which(year==currentyear)],
current_ci = ci[which(year==currentyear)],
p_diff=abs(diff(p)),
c=sqrt(sum(ci^2)),
p_signif=p_diff>c,
rev_coded=first(reverse_coded),
thisyear = ifelse(p_signif==TRUE & year[which(p==min(p))]==currentyear, "lower",
ifelse(p_signif==TRUE & year[which(p==min(p))]!=currentyear, "higher",
"same")),
thisyear_imp = ifelse(rev_coded==1 & thisyear=="higher","lower",
ifelse(rev_coded==1 & thisyear=="lower","higher", thisyear)),
thisyear_col = ifelse(thisyear_imp=="higher","#95fb71",
ifelse(thisyear_imp=="lower","#fb7171","#BDBDBD"))
) %>% select(variable, current_percentage, current_ci, thisyear_imp, thisyear_col) -> image_data
image_data %>% filter(grepl("Confident",variable)) -> ni_conf_data
image_data %>% filter(grepl("Victim",variable)) -> ni_crime_data
image_data %>% filter(grepl("Perceived",variable)) -> ni_perc_data
rm(image_data)
rm(image_data,getnames)
ungroup(df) -> df
#update the app data.
save.image(file = "./app/.RData")
shiny::runApp(appDir="./app/")
#police division colours
pdivcols=c("Argyll & West Dunbartonshire (L Division)"='#66C2A5',
"Ayrshire (U Division)"='#FC8D62',
"Dumfries & Galloway (V Division)"='#8DA0CB',
"Edinburgh City (E Division)"='#E78AC3',
"Fife (P Division)"='#A6D854',
"Forth Valley (C Division)"='#FFD92F',
"Greater Glasgow (G Division)"='#E5C494',
"Highlands & Islands (N Division)"='#8DD3C7',
"Lanarkshire (Q Division)"='#F93D28',
"Lothians & Scottish Borders (J Division)"='#BEBADA',
"NA"='#FFFFB3',
"North East (A Division)"='#80B1D3',
"Renfrewshire & Inverclyde (K Division)"='#FDB462',
"Tayside (D Division)"='#B3DE69',
"National Average"='#000000')
#update the app data.
save.image(file = "./app/.RData")
shiny::runApp(appDir="./app/")
RColorBrewer::brewer.pal(9,"Set1")
RColorBrewer::brewer.pal(9,"Dark2")
RColorBrewer::brewer.pal(8,"Dark2")
#police division colours
pdivcols=c("Argyll & West Dunbartonshire (L Division)"='#E41A1C',
"Ayrshire (U Division)"='#377EB8',
"Dumfries & Galloway (V Division)"='#4DAF4A',
"Edinburgh City (E Division)"='#984EA3',
"Fife (P Division)"='#FF7F00',
"Forth Valley (C Division)"='#FFFF33',
"Greater Glasgow (G Division)"='#A65628',
"Highlands & Islands (N Division)"='#F781BF',
"Lanarkshire (Q Division)"='#1B9E77',
"Lothians & Scottish Borders (J Division)"='#D95F02',
"North East (A Division)"='#7570B3',
"Renfrewshire & Inverclyde (K Division)"='#66A61E',
"Tayside (D Division)"='#E6AB02',
"National Average"='#000000')
#colours for overview page (national avg = black, and better/worse/none is included)
overview_cols=c(pdivcols,
"No difference"="#BDBDBD",
"More Positive"="#95fb71",
"Less Positive"="#fb7171")
#update the app data.
save.image(file = "./app/.RData")
shiny::runApp(appDir="./app/")
data_files <- dir(path = "/data/", pattern='SCJS*', recursive = T,full.names = T)
data_files <- dir(path = "data/", pattern='SCJS*', recursive = T,full.names = T)
# READ IN DATA.
# if you want more variables, you need to add in the string (lowercase) to identify those questions.
all_data <- bind_rows(lapply(data_files, function(x) extract_name_data(x,"serial|age|laa|hba|cjaa|gen|urb|tenure|soc|nssec|simd|wgtg|prev|qpolconf|qs2area|qsfdark|qsfnigh|qratpol|polop|compol|polpres|qworr|numcar|nummot|qaco_|lcpeop|qhworr|qswem|dconf")), .id = "year")
#load in functions
source("setup/extract_name_data.R")
# READ IN DATA.
# if you want more variables, you need to add in the string (lowercase) to identify those questions.
all_data <- bind_rows(lapply(data_files, function(x) extract_name_data(x,"serial|age|laa|hba|cjaa|gen|urb|tenure|soc|nssec|simd|wgtg|prev|qpolconf|qs2area|qsfdark|qsfnigh|qratpol|polop|compol|polpres|qworr|numcar|nummot|qaco_|lcpeop|qhworr|qswem|dconf")), .id = "year")
shiny::runApp(appDir="./app/")
df %>% names()
df<-readRDS("data/pdiv9.6.test.rds")
df %>% names()
#police division colours
pdivcols=c("Argyll & West Dunbartonshire (L Division)"='#E41A1C',
"Ayrshire (U Division)"='#377EB8',
"Dumfries & Galloway (V Division)"='#4DAF4A',
"Edinburgh City (E Division)"='#984EA3',
"Fife (P Division)"='#FF7F00',
"Forth Valley (C Division)"='#FFFF33',
"Greater Glasgow (G Division)"='#A65628',
"Highlands & Islands (N Division)"='#F781BF',
"Lanarkshire (Q Division)"='#1B9E77',
"Lothians & Scottish Borders (J Division)"='#D95F02',
"North East (A Division)"='#7570B3',
"Renfrewshire & Inverclyde (K Division)"='#66A61E',
"Tayside (D Division)"='#E6AB02',
"National Average"='#000000')
#colours for overview page (national avg = black, and better/worse/none is included)
overview_cols=c(pdivcols,
"No difference"="#BDBDBD",
"More Positive"="#95fb71",
"Less Positive"="#fb7171")
#modebar icons to remove (these are the little buttons on the plots.)
modebar_remove <- c('hoverClosestCartesian','hoverCompareCartesian','zoom2d','pan2d','toggleSpikelines','select2d','lasso2d','zoomIn2d','zoomOut2d')
des_factor <- df %>% group_by(year) %>% summarise(des_f=first(des_fact)) #design factors
pdivis<-levels(factor(df$police_div)) #police divisions
years=levels(df$year) #years
currentyear=years[length(years)] #latest survey year
prevyear=years[length(years)-1] #previous survey year
firstyear=years[1] #first survey year
yn<-c("Yes","No") #yes no choices
getnames<-function(string){
df %>%
filter(grepl(string,variable)) %>%
pull(name_trunc) %>%
unique() %>%
as.character()
}
#variables/variable groupings
all_vars<-list('National Indicators'= getnames("PREVSURVEY|QS2AREA:|DCONF_03"),
'Rates of Crime Victimisation'=getnames("PREV"),
'Confidence in the Police'=getnames("POLCONF|RATPOL"),
'Attitudes to the Police'=getnames("POLOP|POLPRES"),
'Confidence in Scottish Criminal Justice System'=getnames("DCONF"),
'Perceptions of Crime Rates and Safety'=getnames("QS"),
'Perceptions of Local Crime'=getnames("QACO"),
'Perceptions of Local People'=getnames("LCPEOP"),
'Worries of Crime Victimisation'=getnames("QWORR"),
'Worries of Being Harassed'=getnames("HWORR")
)
#now overwrite variable with more user-friendly input
df$variable<-df$name_trunc
######## map data ##########
pd_latlon <- readRDS("data/pd_mapdata.RDS")
######## national indicator data #########
df %>% filter(police_div=="National Average",
year %in% c(currentyear,prevyear),
variable %in% all_vars[[1]]) %>%
group_by(variable) %>%
summarise(
current_percentage = percentage[which(year==currentyear)],
current_ci = ci[which(year==currentyear)],
p_diff=abs(diff(p)),
c=sqrt(sum(ci^2)),
p_signif=p_diff>c,
rev_coded=first(reverse_coded),
thisyear = ifelse(p_signif==TRUE & year[which(p==min(p))]==currentyear, "lower",
ifelse(p_signif==TRUE & year[which(p==min(p))]!=currentyear, "higher",
"same")),
thisyear_imp = ifelse(rev_coded==1 & thisyear=="higher","lower",
ifelse(rev_coded==1 & thisyear=="lower","higher", thisyear)),
thisyear_col = ifelse(thisyear_imp=="higher","#95fb71",
ifelse(thisyear_imp=="lower","#fb7171","#BDBDBD"))
) %>% select(variable, current_percentage, current_ci, thisyear_imp, thisyear_col) -> image_data
image_data %>% filter(grepl("Confident",variable)) -> ni_conf_data
image_data %>% filter(grepl("Victim",variable)) -> ni_crime_data
image_data %>% filter(grepl("Perceived",variable)) -> ni_perc_data
rm(image_data,getnames)
ungroup(df) -> df
#update the app data.
save.image(file = "./app/.RData")
shiny::runApp(appDir="./app/")
names(df)
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
?tabPanel
?source
?source
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
source("source/ui_trends.R",echo=F)
source("app/source/ui_trends.R",echo=F)
source("app/source/ui_trends.R")
source("app/source/ui_trends.R",print.eval=T)
source("app/source/ui_trends.R",print.=T)
source("app/source/ui_trends.R",print.=F)
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
?invisible
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
ui_trends<-function(id){
sidebarLayout(
sidebarPanel(
############### INPUTS/SIDE PANEL
div(class="sidebartext",
tags$p("Here you can visualise trends over time of various questions of the survey."),
tags$p("Choose a section of the survey to focus on, and then explore the variables which the SCJS collects in that area. You can also pick and choose which police divisions to show."),
tags$p("Information regarding confidence intervals and sample sizes is available when hovering the mouse over a line on the plot."),
actionLink("link_compare1",
"While confidence intervals go some way to indicating significantly different results, if you wish to find out whether two percentages are significantly different or not, head to the comparison tool.")
),
selectizeInput("trends_pdiv",label="Choose Police Divisions",choices=pdivis, selected="National Average", multiple = T, options = list(maxItems = length(pdivis))),
selectizeInput("trends_var", label = "Choose a section of the survey", choices=list("Survey Sections"=names(all_vars)), selected=names(all_vars)[1], multiple=F),
uiOutput('trends_var2')
),
############### OUTPUTS/PLOT PANEL
mainPanel(
div(class="plot-container",
tags$img(src="spinner.gif", id="loading-spinner"),
plotlyOutput("trendplot", height = "100%",width='100%')),
div(class="plot-below",
tags$p("Hover over the cursor over a point to see more information."),
checkboxInput("erbar",label = "Show Confidence Intervals",value=TRUE),
checkboxInput("showleg1",label = "Show Legend",value=TRUE),
actionButton("reset_trends","Reset plot")
)
)
)
}
shiny::runApp(appDir="./app/")
?NS
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
shiny::runApp(appDir="./app/")
